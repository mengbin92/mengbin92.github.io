---
layout: post
title: BTC交易流程
tags: blockchain
mermaid: true
math: false
---  

## 交易流程

比特币的交易流程涉及多个步骤和参与方，包括发送方、接收方、矿工和比特币网络中的节点。以下是比特币交易的详细流程：

1. **创建交易**:
   - 生成比特币地址：比特币地址是一个由公钥生成的字符串，用于接收比特币。每个用户在创建比特币钱包时，都会生成一对公钥和私钥。公钥通过哈希算法生成比特币地址，私钥用于签名交易。
   - 创建交易信息：交易信息包括以下几个部分：
     - **输入（Inputs）**：包含发送方的比特币地址和之前交易的输出（即发送方要花费的比特币）。
     - **输出（Outputs）**：包含接收方的比特币地址和发送的比特币数量。
     - **交易额外信息**：包括交易费等。
2. **签名交易**：发送方使用私钥对交易信息进行签名。签名的目的是证明交易的合法性和发送方对比特币的所有权。签名后的交易信息会被广播到比特币网络。
3. **广播交易**： 签名后的交易信息通过比特币网络广播到其他节点。每个节点都会验证交易的合法性，包括检查签名是否有效、输入是否未被双花（即同一笔比特币是否未被多次使用）等。
4. **矿工打包交易**： 矿工从比特币网络中收集未确认的交易，并将这些交易打包到一个新的区块中。矿工会优先选择交易费较高的交易进行打包。
5. **工作量证明（PoW）**： 矿工需要通过工作量证明（PoW）算法来解决一个复杂的数学问题。具体来说，矿工需要找到一个随机数（Nonce），使得整个区块的哈希值满足目标难度。这个过程称为挖矿。
6. **广播新区块**： 一旦矿工找到符合条件的哈希值，他们会将新区块广播到比特币网络。其他节点会验证新区块的合法性，包括检查哈希值是否符合目标难度、交易的合法性等。
7. **区块链更新**： 验证通过后，新区块会被添加到区块链中，成为区块链的最新部分。此时，交易被确认并记录在区块链中。
8. **交易确认**： 交易被打包到区块中并添加到区块链后，交易会获得一次确认。随着新区块的不断添加，交易会获得更多的确认。一般来说，6次确认被认为是安全的，意味着交易已经被多个区块确认，难以被篡改。
9. **接收方验证交易**： 接收方可以通过比特币网络查询交易状态，确认交易是否被记录在区块链中以及获得的确认次数。一旦交易获得足够的确认，接收方可以认为交易是安全的，已成功接收比特币。

## 广播交易

以下是一个比特币交易广播的示例流程图：  

```mermaid
graph TD
    A[用户创建并签名交易] --> B[发送交易到本地节点]
    B --> C[本地节点验证交易]
    C --> D[广播交易到邻近节点]
    D --> E[邻近节点验证并广播交易]
    E --> F[交易在网络中传播]
    F --> G[交易进入内存池]
    G --> H[矿工选择并打包交易]
    H --> I[广播新区块]
    I --> J[区块链更新]
```

广播过程涉及到**P2P网络**和**Gossip协议**：  

- **P2P网络**：比特币网络是一个P2P网络，由许多节点组成。每个节点都连接到其他节点，并通过P2P协议与其他节点交换信息。节点之间可以相互通信，交换交易、区块等信息。
- **Gossip协议**：比特币网络使用一种称为Gossip协议的传播机制。每个节点会将接收到的新交易信息传递给它的所有邻近节点，邻近节点再继续传递，直到整个网络中的所有节点都接收到该交易信息。

**交易验证过程包括**：  

- **检查输入的未花费交易输出（UTXO）**：确保交易输入引用的比特币尚未被花费。
- **签名验证**：使用发送方的公钥验证交易的签名，确保发送方对交易输入的比特币拥有所有权。
- **双花检查**：确保交易输入的比特币未被其他交易使用。
- **格式检查**：确保交易的格式符合比特币协议的规范。

---

<div align="center">
  <img src="../img/qrcode_wechat.jpg" alt="孟斯特">
</div>

> 声明：本作品采用[署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)进行许可，使用时请注明出处。  

> Author: [mengbin](mengbin1992@outlook.com)  

> blog: [mengbin](https://mengbin.top)  

> Github: [mengbin92](https://mengbin92.github.io/)  

> cnblogs: [恋水无意](https://www.cnblogs.com/lianshuiwuyi/)  

> 腾讯云开发者社区：[孟斯特](https://cloud.tencent.com/developer/user/6649301)  

---
