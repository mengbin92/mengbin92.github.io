---
layout: post
title: Redis中的缓存雪崩、缓存击穿、缓存穿透问题
tags: redis
mermaid: false
math: false
---  

## 1. 什么是缓存雪崩

当我们提到缓存系统中的问题，缓存雪崩是一个经常被讨论的话题。缓存雪崩是指在某一时刻发生大量的缓存失效，导致瞬间大量的请求直接打到了数据库，可能会导致数据库瞬间压力过大甚至宕机。尤其在高并发的系统中，这种情况会导致连锁反应，整个系统可能会崩溃。

### 1.1 缓存雪崩的成因

1. **大量缓存同时设置相同的过期时间**：如果在某一时刻设置了大量的缓存数据，并为它们都设置了相同的过期时间，那么在未来的某一时刻，这些缓存数据都会同时失效。
2. **Redis宕机**：如果因为某种原因，Redis服务器突然宕机，那么所有的缓存数据都会消失，导致所有的请求都直接访问数据库。
3. **误删缓存数据**：如果由于某种原因，大量的缓存数据被误删除，那么也会引发缓存雪崩。

### 1.2 如何预防缓存雪崩

1. **设置随机过期时间**：为了防止大量的缓存同时失效，我们可以为每个缓存设置一个随机的过期时间，这样就可以确保不会有太多的缓存同时失效。
2. **使用熔断机制**：在系统中加入熔断机制，当数据库请求到达一定的阈值时，直接拒绝部分请求，以保护数据库不被过度访问。
3. **双层缓存策略**：可以使用两层缓存，一层是热数据的缓存，另一层是冷数据的缓存。热数据缓存失效后，可以先访问冷数据缓存，而不是直接访问数据库。
4. **数据预热**：在系统启动后，预先加载部分常用的数据到缓存中，减少在高峰期的数据库访问。
5. **使用高可用架构**：如使用Redis的哨兵模式或者集群模式，确保Redis服务的高可用。
6. **备份和恢复策略**：定期备份Redis数据，并确保在Redis宕机后，可以快速恢复数据。

## 2. 什么是缓存穿透？

在使用缓存的应用程序中，缓存穿透是一种指请求查询一个不存在的数据，由于缓存层不存在这个数据，所以请求会穿过缓存层直接查询数据库，导致数据库压力增加。缓存穿透通常发生在恶意攻击或者系统设计不当的情况下。

### 2.1 导致缓存穿透的原因

1. **恶意攻击**：攻击者有意请求不存在的数据，以使得系统频繁访问数据库，造成拒绝服务攻击。
2. **大量请求**：如果一个不存在的热点数据被大量请求，会导致这些请求穿透缓存层直接访问数据库，增加数据库压力。
3. **缓存数据失效不及时**：当缓存中的数据未及时更新或失效，而恰好有大量请求访问这部分失效的数据时，也会导致缓存穿透问题。

### 2.2 缓解缓存穿透的方法

1. **布隆过滤器**：在缓存层前使用布隆过滤器，对所有可能的数据建立一个布隆过滤器，用于快速判断一个请求的数据是否存在于数据库中。
2. **空结果缓存**：对于数据库中不存在的数据，也将其缓存起来，但设置一个较短的过期时间，避免大量的无效请求直接访问数据库。
3. **合理设置缓存时间**：根据业务场景，合理设置缓存时间，避免缓存数据过早失效导致大量请求穿透。

## 3. 什么是缓存击穿？

缓存击穿是指在高并发环境下，大量请求同时访问缓存中不存在的数据，导致这些请求穿透到数据库。这会对数据库造成严重的压力，降低性能。

### 3.1 缓存穿透与缓存击穿的区别

- **缓存穿透** 是指请求一个不存在于缓存中的数据，导致每次请求都直接查询数据库。
- **缓存击穿** 是指大量请求同时请求一个不存在于缓存中的数据，导致数据库压力骤增。

### 3.2 缓存击穿的原因

缓存击穿通常发生在以下情况下：

- 热点数据：某个数据非常热门，但缓存中没有。
- 缓存失效：缓存中的数据过期，但大量请求仍在访问。
- 同时到期：多个数据同时过期，导致并发查询数据库。

### 3.3. 解决缓存击穿问题

- **使用互斥锁：** 通过在缓存中设置互斥锁，只允许一个线程查询数据库，其他线程等待结果。这可以防止多个请求同时穿透到数据库。
- **预加载数据：** 在缓存中设置数据预加载，避免等待请求引发缓存击穿。这需要定期刷新缓存，确保热门数据始终可用。
- **布隆过滤器：** 使用布隆过滤器检查请求的数据是否存在于缓存中，如果不存在，不查询数据库。这可以减少数据库查询次数。
- **优化数据库查询：** 优化数据库查询性能，减少查询时间，可以降低缓存击穿的风险。使用合适的索引和查询优化策略。

---

<div align="center">
  <img src="../img/qrcode_wechat.jpg" alt="孟斯特">
</div>

> 声明：本作品采用[署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)进行许可，使用时请注明出处。  
> Author: [mengbin](mengbin1992@outlook.com)  
> blog: [mengbin](https://mengbin.top)  
> Github: [mengbin92](https://mengbin92.github.io/)  
> cnblogs: [恋水无意](https://www.cnblogs.com/lianshuiwuyi/)  

---
