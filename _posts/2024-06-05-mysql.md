---
layout: post
title: 使用联合索引优化查询效率
tags: mysql
mermaid: false
math: false
---  

在数据库设计和查询优化中，联合索引是一个强大的工具，它可以显著提高数据检索的速度。然而，要充分利用联合索引的优势，我们需要理解它们是如何影响查询效率的。本文将探讨联合索引的工作原理以及如何使用它们来优化查询。

## 联合索引的工作原理

联合索引的原理基于数据库管理系统（DBMS）如何存储和检索数据的方式。联合索引，也称为复合索引，涉及在数据库表的两个或更多列上创建索引。这种索引类型允许数据库在执行查询时，同时利用多个列的索引，从而提高数据检索的效率。以下是联合索引工作原理的详细介绍：

### 索引结构

大多数数据库系统使用B树（平衡树）或其变种（如B+树）作为索引的底层数据结构。B树是一种自平衡树，它保持数据排序，允许搜索、顺序访问、插入和删除操作在对数时间内完成。在联合索引中，B树的每个节点不仅包含单个键值，而是包含了多个列的键值组合。

### 键值组合

在联合索引中，索引的键是由多个列的值组合而成的。例如，如果有一个联合索引包含列A和列B，那么索引的键将是(A, B)的值对。数据库在创建索引时，会根据这些列的值对数据进行排序和存储。

### 索引顺序

在联合索引中，列的顺序非常重要。索引的效率取决于查询条件如何与索引列的顺序匹配。数据库在处理查询时，会按照索引定义中的列顺序从左到右匹配条件。如果查询的第一个条件是索引的第一个列，那么数据库可以高效地利用索引。如果查询的第一个条件不是索引的第一个列，索引的效果会大打折扣。

### 索引查找

当数据库执行一个查询时，它会尝试使用可用的索引来加速数据检索。对于联合索引，数据库会在B树中查找满足查询条件的键值组合。这个过程通常涉及到遍历B树的路径，直到找到匹配的节点。由于数据已经根据索引键排序，数据库可以快速定位到满足条件的数据范围，然后从中检索需要的记录。

### 等值和范围查询

联合索引对等值查询（例如`WHERE A=1 AND B=2`）特别有效，因为它可以直接定位到具有特定键值组合的记录。对于范围查询（例如`WHERE A=1 AND B>2`），联合索引同样有用，但是一旦遇到范围条件，索引中该条件之后的列就不会被用于优化查询。

### 索引覆盖

如果一个查询只需要访问联合索引中的列，那么这个查询可以完全通过索引来满足，无需访问表中的实际数据。这种情况被称为索引覆盖，可以极大地提高查询性能。

## 示例  

以下面的SQL为例：  

```sql 
CREATE TABLE test (
    id INT NOT NULL AUTO_INCREMENT,
    a INT NOT NULL,
    b INT NOT NULL,
    c INT NOT NULL,
    PRIMARY KEY (id)
);
```  

查询时，如果使用下面的SQL：  

```sql 
SELECT * FROM test WHERE a = 1 AND b = 1 AND c = 1;
```  

在数据量不大的时候，这个查询的速度可能很快，但是随着数据量的增加，查询速度可能会变慢。这是因为数据库需要遍历整个表，才能找到满足条件的记录。如果使用联合索引，查询速度会更快。例如，如果使用下面的SQL：  

```sql
CREATE INDEX idx_abc ON test (a, b, c);
```  

那么查询速度会更快，因为数据库可以利用索引来快速定位到满足条件的记录。  

此外，尽管`SELECT *`使用很方便，但在生产环境中，应该尽量避免使用`SELECT *`，因为这可能会导致不必要的数据传输。应该只选择需要的列，以提高查询性能。  

在B+树索引结构中，联合索引 `a`, `b`, `c` 的创建意味着索引项是按照这三个列的值的组合排序的。在B+树中，所有的值都存储在叶子节点上，并且叶子节点是以链表的形式相互连接的，这允许快速的范围访问。

在B+树索引中，等值查询通常非常高效，因为它们可以直接导航到树的特定部分。范围查询也相对高效，因为B+树的叶子节点是有序的，并且可以通过链表顺序访问。但是，当范围查询介入时，索引的效率可能会降低，因为数据库需要遍历更多的索引项来找到所有匹配的记录。

### 联合索引中字段顺序的影响

在上面的例子中，我们创建了联合索引，在实际使用中下面两个查询的性能是相同的：  

```sql
SELECT * FROM test WHERE a = 1 AND b = 1 AND c = 1;
SELECT * FROM test WHERE a = 1 AND c = 1 AND b = 1;
```  

在大多数现代数据库管理系统（DBMS）中，这两个查询的性能是相同的。这是因为数据库的查询优化器会分析查询条件并决定最有效的方式来使用索引，不管这些条件在`WHERE`子句中的顺序如何。  

### WHERE a = 1 AND b > 1 AND c = 1 会命中索引吗？

查询 `WHERE a = 1 AND b > 1 AND c = 1` 会利用到 `a`, `b`, `c` 上的联合索引，但是使用方式和完全匹配（`a = 1 AND b = 1 AND c = 1`）的情况有所不同。

**索引的部分使用**

在这个查询中，因为 `a` 和 `c` 的条件是等值查询（`=`），而 `b` 是范围查询（`>`），数据库可以利用联合索引的前缀部分来优化查询。具体来说：

- **对 `a` 的等值查询**：这个条件可以直接利用索引，因为 `a` 是联合索引的第一个字段。数据库可以快速定位到 `a = 1` 的记录。
- **对 `b` 的范围查询**：由于 `b` 紧随 `a` 后面，数据库可以在 `a = 1` 的基础上进一步利用索引来处理 `b > 1` 的条件。这个步骤会筛选出 `a = 1` 且 `b > 1` 的记录。
- **对 `c` 的等值查询**：尽管 `c` 也是索引的一部分，但由于 `b` 的条件是一个范围查询，对 `c` 的等值查询的优化效果会受到一定影响。数据库仍然可以利用索引，但是在处理 `b` 的范围查询之后，对 `c` 的过滤可能需要在已筛选的结果集上进行。

---

<div align="center">
  <img src="../img/qrcode_wechat.jpg" alt="孟斯特">
</div>

> 声明：本作品采用[署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)进行许可，使用时请注明出处。  

> Author: [mengbin](mengbin1992@outlook.com)  

> blog: [mengbin](https://mengbin.top)  

> Github: [mengbin92](https://mengbin92.github.io/)  

> cnblogs: [恋水无意](https://www.cnblogs.com/lianshuiwuyi/)  

> 腾讯云开发者社区：[孟斯特](https://cloud.tencent.com/developer/user/6649301)  

---

