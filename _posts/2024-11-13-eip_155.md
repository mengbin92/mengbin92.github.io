---
layout: post
title: only replay-protected (EIP-155) transactions allowed over RPC
tags: ethereum
mermaid: false
math: false
---  

在使用以太坊节点进行 RPC 调用时，常常会遇到 `only replay-protected (EIP-155) transactions allowed over RPC` 的错误提示。这个错误通常出现在试图发送不符合 **EIP-155** 标准的交易时。本文将解释为什么会出现这个错误，同时还会简单介绍 **EIP-155** 标准以及它的背景。

---

## 为什么会出现这个错误？

**错误原因**：  

在以太坊中，交易的签名通常包含交易的 `nonce`、`gasPrice`、`to`、`data` 等信息，用来确保交易的唯一性。最初的以太坊设计并没有特别针对交易的重放攻击（replay attack）进行保护，导致在不同链上发生重放攻击的可能性。

随着以太坊的分叉（例如以太坊和以太坊经典的分裂），这种风险变得更加严重。为了防止在不同链之间的交易重放，**EIP-155** 提出了一个新的交易标准，确保交易签名能唯一标识特定网络。具体来说，EIP-155 增加了一个 **链ID（Chain ID）** 字段，使得不同链上的交易无法互相重放。

如果你在向以太坊节点发送交易时，未正确指定链ID，或者发送的交易不符合 EIP-155 标准，那么就会触发该错误：`only replay-protected (EIP-155) transactions allowed over RPC`，提示你必须发送符合 EIP-155 保护的交易。

**触发该错误的常见原因**：

1. **未指定链ID**：如果你没有为交易签名指定正确的链ID，那么该交易将无法通过节点的 EIP-155 校验，导致出错。
2. **网络和链ID不匹配**：如果你的交易是针对一个特定链的，但链ID与目标网络不匹配，也会导致这个错误。
3. **使用了不符合 EIP-155 标准的工具**：某些以太坊钱包或工具可能不遵循 EIP-155 标准，发送的交易没有进行链ID保护。

---

## 什么是 EIP-155？

**EIP-155** 是以太坊的一个提案，它的目的是通过在交易中引入链ID来防止 **重放攻击**。重放攻击是指，攻击者通过复制一笔有效的交易，并在另一个链上重新提交它，从而可能导致恶意行为或错误操作。

### EIP-155 的核心内容  

EIP-155 引入了链ID（Chain ID）字段，并要求每个交易在签名时包含链ID。链ID 是一个与链相关的数字标识符，用来区分不同的区块链网络。例如：

- 主网（Mainnet）的链ID是 `1`。
- 测试网 Rinkeby 的链ID是 `4`。
- 测试网 Ropsten 的链ID是 `3`。

具体来说，EIP-155 通过修改交易的签名部分来实现交易的保护机制。传统的以太坊交易签名不包含链ID，容易发生重放攻击。EIP-155 在交易签名时加入了链ID，确保每个链上的交易具有唯一性。

### EIP-155 是如何工作的？

在以太坊中，交易的签名通常使用以下公式：

\[
S = H(Nonce || GasPrice || GasLimit || To || Value || Data || ChainID) 
\]

其中，`ChainID` 是新增的字段，防止交易在其他链上被重放。通过将链ID嵌入签名过程中，交易的有效性就被限制在特定的链上，确保该交易无法在其他链上重复使用。

### 交易签名示例

对于一个交易，如果没有使用 EIP-155 标准，它的签名将是基于交易的内容（如 `nonce`、`gasPrice` 等）生成的。如果一个交易没有包含链ID，它就有可能在不同的以太坊链上被重放，导致潜在的安全问题。而在 EIP-155 的设计下，交易的签名就包括了链ID，因此该交易只能在特定链上有效。

---

## EIP-155 背景与出现的原因

在 **2016 年**，以太坊经历了 **DAO 攻击** 事件，这次事件导致了以太坊社区决定对以太坊区块链进行硬分叉，创建了以太坊经典（Ethereum Classic）和以太坊（Ethereum）两个独立的链。在这个分叉过程中，**重放攻击** 成为一个严重的安全问题，攻击者可以将一个链上的交易拷贝到另一个链上进行重放，导致资金丧失或错误操作。

为了避免这个问题，以太坊提出了 EIP-155，它通过引入链ID保护来确保交易不能在不同链之间互相重放。例如，针对以太坊主网的交易在以太坊经典链上将无法生效，因为签名中包含的链ID与目标链不匹配，从而阻止了重放攻击。

### EIP-155 的推广与应用

EIP-155 被正式应用于以太坊网络之后，所有支持 EIP-155 的节点都会在接受交易时检查链ID。如果交易中的链ID与当前网络的链ID不匹配，交易就会被拒绝。这样就避免了在多个链之间的交易重放问题。

EIP-155 主要应用于以下场景：

- **避免重放攻击**：当你在不同的以太坊链（例如主网、测试网）之间进行交易时，EIP-155 确保交易只能在一个链上有效。
- **链的安全性**：EIP-155 确保了交易的唯一性，使得跨链交易不会因为链ID不同而被误操作。

---

## 如何解决这个错误？

### 1. 确保交易签名正确

- 如果你在使用某些工具（例如 Web3.js、web3j、Geth 等）发起交易，确保你在交易中正确设置了链ID。
- 在创建交易时，如果你使用了 **Web3.js** 或 **web3j**，确保链ID被正确传递给交易签名。例如，在 Web3.js 中，你可以通过 `chainId` 选项来指定链ID：

```javascript
web3.eth.sendTransaction({
    from: '0xYourAddress',
    to: '0xRecipientAddress',
    value: web3.utils.toWei('1', 'ether'),
    gas: 21000,
    chainId: 1  // 主网
});
```

### 2. 检查你连接的节点

如果你连接的是一个 RPC 节点（例如 Infura、Alchemy），确保该节点支持 EIP-155 并且你正在连接正确的网络（例如主网、测试网）。

### 3. 升级你的工具或库

如果你使用的是较旧版本的工具或库，可能不支持 EIP-155 标准。确保你使用的是支持 EIP-155 的最新版本。

---

**EIP-155** 是以太坊网络的重要改进，它通过引入链ID保护机制，成功地避免了重放攻击问题。通过理解 EIP-155 的工作原理和背景，我们可以更好地确保自己的交易安全。出现 `only replay-protected (EIP-155) transactions allowed over RPC` 错误时，我们可以检查交易签名中的链ID，确保交易符合 EIP-155 标准，从而顺利地进行交易。

---

<div align="center">
  <img src="../img/qrcode_wechat.jpg" alt="孟斯特">
</div>

> 声明：本作品采用[署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)进行许可，使用时请注明出处。  
> Author: [mengbin](mengbin1992@outlook.com)  
> blog: [mengbin](https://mengbin.top)  
> Github: [mengbin92](https://mengbin92.github.io/)  
> cnblogs: [恋水无意](https://www.cnblogs.com/lianshuiwuyi/)  
> 腾讯云开发者社区：[孟斯特](https://cloud.tencent.com/developer/user/6649301)  
---