---
layout: post
title: chromedpç®€ä»‹
tags: go
mermaid: false
math: false
---  

## å¼•è¨€ï¼šä¸ºä»€ä¹ˆé€‰æ‹© chromedpï¼Ÿ

åœ¨ç°ä»£ Web å¼€å‘ä¸­ï¼Œæµè§ˆå™¨è‡ªåŠ¨åŒ–å·²æˆä¸ºæå‡æ•ˆç‡çš„å…³é”®æŠ€æœ¯ã€‚å¯¹äº Go å¼€å‘è€…è€Œè¨€ï¼Œ[chromedp](https://github.com/chromedp/chromedp) æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œå®ƒé€šè¿‡ Chrome DevTools åè®®ç›´æ¥æ§åˆ¶ Chrome/Chromium æµè§ˆå™¨ï¼Œæ— éœ€é¢å¤–ä¾èµ–å¦‚ Selenium æˆ– WebDriverã€‚

### chromedp çš„æ ¸å¿ƒä¼˜åŠ¿ï¼š

- **åŸç”Ÿ Go å®ç°**ï¼šæ— ç¼é›†æˆåˆ° Go é¡¹ç›®ä¸­
- **é«˜æ€§èƒ½**ï¼šç›´æ¥é€šè¿‡ CDP åè®®é€šä¿¡ï¼Œé€Ÿåº¦è¿œè¶…ä¼ ç»Ÿæ–¹æ¡ˆ
- **ç®€æ´ API**ï¼šGo é£æ ¼çš„ä¼˜é›…è®¾è®¡ï¼Œå­¦ä¹ æ›²çº¿å¹³ç¼“
- **åŠŸèƒ½å…¨é¢**ï¼šæ”¯æŒæ‰€æœ‰ Chrome DevTools åŠŸèƒ½
- **è½»é‡çº§**ï¼šæ— éœ€é¢å¤–ä¾èµ–ï¼Œèµ„æºå ç”¨ä½

## å®‰è£…ä¸ç¯å¢ƒé…ç½®

å®‰è£… chromedp ä»…éœ€ä¸€è¡Œå‘½ä»¤ï¼š

```bash
$ go get -u github.com/chromedp/chromedp
```

ç¡®ä¿ç³»ç»Ÿä¸­å·²å®‰è£… Chrome æˆ– Chromium æµè§ˆå™¨ã€‚éªŒè¯å®‰è£…ï¼š

```go
package main

import (
    "github.com/chromedp/chromedp"
    "log"
)

func main() {
    // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦å¯ç”¨
    _, err := chromedp.NewExecAllocator(context.Background())
    if err != nil {
        log.Fatal("Chrome/Chromium æœªå®‰è£…:", err)
    }
    log.Println("ç¯å¢ƒé…ç½®æˆåŠŸ!")
}
```

## å¿«é€Ÿå…¥é—¨ï¼šç¬¬ä¸€ä¸ªè‡ªåŠ¨åŒ–ç¨‹åº

```go
package main

import (
    "context"
    "io/ioutil"
    "log"

    "github.com/chromedp/chromedp"
)

func main() {
    // åˆ›å»ºä¸Šä¸‹æ–‡
    ctx, cancel := chromedp.NewContext(context.Background())
    defer cancel()
    
    // å­˜å‚¨æˆªå›¾æ•°æ®
    var buf []byte
    
    // æ‰§è¡Œä»»åŠ¡é“¾
    err := chromedp.Run(ctx,
        chromedp.Navigate("https://github.com"),
        chromedp.WaitVisible(`input[name="q"]`, chromedp.ByQuery),
        chromedp.Screenshot(`body`, &buf, chromedp.NodeVisible, chromedp.ByQuery),
    )
    if err != nil {
        log.Fatal(err)
    }
    
    // ä¿å­˜æˆªå›¾
    if err := ioutil.WriteFile("github-home.png", buf, 0644); err != nil {
        log.Fatal(err)
    }
    log.Println("æˆªå›¾ä¿å­˜æˆåŠŸ!")
}
```

è¿™ä¸ªç¨‹åºå®Œæˆäº†ï¼š

1. æ‰“å¼€ GitHub ä¸»é¡µ
2. ç­‰å¾…æœç´¢æ¡†åŠ è½½å®Œæˆ
3. æˆªå–æ•´ä¸ªé¡µé¢
4. ä¿å­˜ä¸º PNG æ–‡ä»¶

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 1. é¡µé¢å¯¼èˆªä¸ç­‰å¾…ç­–ç•¥

```go
// åŸºæœ¬å¯¼èˆª
chromedp.Navigate("https://example.com"),

// ç­‰å¾…å…ƒç´ å¯è§ï¼ˆæ¨èï¼‰
chromedp.WaitVisible("#content", chromedp.ByID),

// ç­‰å¾…å…ƒç´ å­˜åœ¨
chromedp.WaitPresent(".result-item", chromedp.ByQuery),

// ç­‰å¾…å…ƒç´ æ¶ˆå¤±
chromedp.WaitNotPresent("#loading-indicator", chromedp.ByQuery),

// ç­‰å¾…é¡µé¢æ ‡é¢˜
chromedp.WaitTitle("Example Domain"),
```

### 2. å…ƒç´ å®šä½ä¸äº¤äº’

chromedp æ”¯æŒå¤šç§å®šä½ç­–ç•¥ï¼š
```go
// é€šè¿‡ CSS é€‰æ‹©å™¨ï¼ˆé»˜è®¤ï¼‰
chromedp.Click("button.submit", chromedp.ByQuery)

// æ˜ç¡®æŒ‡å®šé€‰æ‹©å™¨ç±»å‹
chromedp.Click(`//button[text()="Submit"]`, chromedp.BySearch)

// é€šè¿‡ ID
chromedp.SendKeys("#username", "user@example.com", chromedp.ByID)

// ç»„åˆä½¿ç”¨
chromedp.SetValue(
    `input[name="email"]`, 
    "contact@example.com", 
    chromedp.ByQuery,
    chromedp.NodeVisible,
)
```

### 3. æ‰§è¡Œ JavaScript

```go
// æ‰§è¡Œç®€å•JS
chromedp.Evaluate(`window.scrollTo(0, document.body.scrollHeight)`, nil),

// è·å–è¿”å›å€¼
var title string
chromedp.Evaluate(`document.title`, &title),

// æ‰§è¡Œå¼‚æ­¥JS
chromedp.EvaluateAsDevTools(`
    new Promise(resolve => {
        setTimeout(() => resolve('Done!'), 2000)
    })`, 
    &result,
),
```

### 4. æˆªå›¾ä¸ PDF å¯¼å‡º

```go
// å…¨å±æˆªå›¾ï¼ˆé«˜è´¨é‡ï¼‰
chromedp.FullScreenshot(&buf, 90)

// å…ƒç´ æˆªå›¾
chromedp.Screenshot("#main-content", &buf, chromedp.ByID)

// å¯¼å‡ºä¸º PDF
chromedp.PrintToPDF(&pdfBuf, chromedp.WithPrintOptions(
    &page.PrintToPDFParams{
        Landscape: true,
        PrintBackground: true,
        PaperWidth: 11,
        PaperHeight: 8.5,
    })),
```

## æ¡ˆä¾‹ï¼šGitHub ä»“åº“æ•°æ®æŠ“å–

```go
func fetchRepoStats(repoURL string) (stars, forks, issues string) {
    ctx, cancel := chromedp.NewContext(context.Background())
    defer cancel()
    
    chromedp.Run(ctx,
        chromedp.Navigate(repoURL),
        chromedp.WaitVisible(`h1`),
        
        // æå–å…³é”®æŒ‡æ ‡
        chromedp.Text(`a[href$="/stargazers"]`, &stars, chromedp.ByQuery),
        chromedp.Text(`a[href$="/forks"]`, &forks, chromedp.ByQuery),
        chromedp.Text(`a[href$="/issues"]`, &issues, chromedp.ByQuery),
    )
    return
}
```

ä½¿ç”¨ç¤ºä¾‹ï¼š

```go
stars, forks, issues := fetchRepoStats("https://github.com/chromedp/chromedp")
fmt.Printf("é¡¹ç›®ç»Ÿè®¡:\nâ­ Stars: %s\nğŸ´ Forks: %s\nâ— Issues: %s\n", stars, forks, issues)
```

## é«˜çº§é…ç½®æŠ€å·§

### 1. æµè§ˆå™¨é€‰é¡¹å®šåˆ¶

```go
opts := append(chromedp.DefaultExecAllocatorOptions[:],
    chromedp.Flag("headless", false),         // ç¦ç”¨æ— å¤´æ¨¡å¼
    chromedp.Flag("disable-gpu", true),       // ç¦ç”¨ GPU åŠ é€Ÿ
    chromedp.Flag("ignore-certificate-errors", true), // å¿½ç•¥è¯ä¹¦é”™è¯¯
    chromedp.Flag("window-size", "1280,800"), // è®¾ç½®çª—å£å¤§å°
    chromedp.UserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64)"), // è‡ªå®šä¹‰ UA
    chromedp.Flag("lang", "zh-CN"),          // è®¾ç½®ä¸­æ–‡ç¯å¢ƒ
)

allocCtx, cancel := chromedp.NewExecAllocator(context.Background(), opts...)
defer cancel()
```

### 2. ç§»åŠ¨è®¾å¤‡æ¨¡æ‹Ÿ

```go
// è®¾ç½®è§†å£
chromedp.EmulateViewport(375, 812), // iPhone X å°ºå¯¸

// è®¾ç½®ç”¨æˆ·ä»£ç†
chromedp.ActionFunc(func(ctx context.Context) error {
    return emulation.SetUserAgentOverride("Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X)").Do(ctx)
}),
```

### 3. å¤„ç†è®¤è¯å¼¹çª—

```go
chromedp.Run(ctx,
    chromedp.Navigate("https://protected-site.com"),
    chromedp.ActionFunc(func(ctx context.Context) error {
        // ç›‘å¬è®¤è¯å¯¹è¯æ¡†
        c := chromedp.ListenTarget(ctx, func(ev interface{}) {
            if ev, ok := ev.(*page.EventJavascriptDialogOpening); ok {
                go func() {
                    _ = chromedp.Run(ctx,
                        page.HandleJavaScriptDialog(true),
                        chromedp.SendKeys("", "username"),
                        chromedp.SendKeys("", "password"),
                        chromedp.Click("#confirm-button"),
                    )
                }()
            }
        })
        return c
    }),
)
```

### 4. ä¼˜åŒ–æ€§èƒ½ä¸èµ„æºç®¡ç†

```go
// å¤ç”¨æµè§ˆå™¨å®ä¾‹
browserCtx, cancel := chromedp.NewContext(context.Background())
defer cancel()

// åˆ›å»ºå¤šä¸ªæ ‡ç­¾é¡µå¹¶è¡Œæ‰§è¡Œ
var wg sync.WaitGroup
for i := 0; i < 5; i++ {
    wg.Add(1)
    go func(i int) {
        defer wg.Done()
        tabCtx, _ := chromedp.NewContext(browserCtx)
        // æ‰§è¡Œç‹¬ç«‹ä»»åŠ¡...
    }(i)
}
wg.Wait()
```

## æœ€ä½³å®è·µ

### 1. ä»»åŠ¡ç»„ç»‡

ä½¿ç”¨ `chromedp.Tasks` æé«˜ä»£ç å¯è¯»æ€§ï¼š
```go
tasks := chromedp.Tasks{
    chromedp.Navigate("https://example.com"),
    chromedp.WaitVisible("#content"),
    chromedp.Click("#submit-btn"),
    chromedp.WaitNotPresent("#loading"),
    chromedp.Text("#result", &result),
}
chromedp.Run(ctx, tasks)
```

### 2. å¥å£®çš„é”™è¯¯å¤„ç†

```go
if err := chromedp.Run(ctx, tasks...); err != nil {
    if errors.Is(err, context.DeadlineExceeded) {
        log.Println("æ“ä½œè¶…æ—¶")
    } else if errors.Is(err, chromedp.ErrNoResults) {
        log.Println("å…ƒç´ æœªæ‰¾åˆ°")
    } else {
        log.Fatalf("è¿è¡Œæ—¶é”™è¯¯: %v", err)
    }
}
```

### 3. ååçˆ¬è™«ç­–ç•¥

```go
opts := append(chromedp.DefaultExecAllocatorOptions[:],
    chromedp.Flag("disable-blink-features", "AutomationControlled"), // éšè—è‡ªåŠ¨åŒ–æ ‡è®°
    chromedp.UserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"),
    chromedp.Flag("headless", true),
    chromedp.Flag("disable-web-security", true),
)

// æ·»åŠ éšæœºå»¶è¿Ÿæ¨¡æ‹Ÿäººç±»æ“ä½œ
chromedp.Sleep(time.Duration(rand.Intn(3000)) * time.Millisecond),
```

## å¸¸è§é—®é¢˜è§£å†³

1. **å…ƒç´ å®šä½å¤±è´¥**
   - ä½¿ç”¨ `chromedp.WaitReady(selector)` ç¡®ä¿å…ƒç´ å®Œå…¨åŠ è½½
   - å°è¯•å¤šç§å®šä½ç­–ç•¥ï¼š`ByQuery`, `BySearch`, `ByID`
   - å¢åŠ è¶…æ—¶æ—¶é—´ï¼š`chromedp.WithTimeout(30*time.Second)`
2. **ä¸­æ–‡æ¸²æŸ“é—®é¢˜**
   ```go
   chromedp.Flag("lang", "zh-CN,zh;q=0.9"),
   chromedp.UserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"),
   ```
3. **å†…å­˜æ³„æ¼é¢„é˜²**
   - ç¡®ä¿è°ƒç”¨ `cancel()` å‡½æ•°é‡Šæ”¾èµ„æº
   - é¿å…åˆ›å»ºè¿‡å¤šæµè§ˆå™¨å®ä¾‹
   - ä½¿ç”¨ `chromedp.Cancel(ctx)` åŠæ—¶ç»ˆæ­¢ä»»åŠ¡

## åº”ç”¨åœºæ™¯ä¸æ›¿ä»£æ–¹æ¡ˆæ¯”è¾ƒ

### å…¸å‹åº”ç”¨åœºæ™¯

- **ç½‘é¡µæˆªå›¾ä¸PDFå¯¼å‡º**ï¼šç”ŸæˆæŠ¥å‘Šã€ä¿å­˜é¡µé¢å¿«ç…§
- **æ•°æ®æŠ“å–**ï¼šæŠ“å–åŠ¨æ€æ¸²æŸ“çš„å†…å®¹
- **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šç«¯åˆ°ç«¯(E2E)æµ‹è¯•
- **æ€§èƒ½ç›‘æ§**ï¼šé¡µé¢åŠ è½½æ€§èƒ½åˆ†æ
- **RPAå·¥å…·**ï¼šè‡ªåŠ¨åŒ–é‡å¤æ€§ç½‘é¡µæ“ä½œ

### å·¥å…·æ¯”è¾ƒ

| å·¥å…·         | è¯­è¨€   | ä¼˜ç‚¹                     | ç¼ºç‚¹                   |
| :----------- | :----- | :----------------------- | :--------------------- |
| **chromedp** | Go     | é«˜æ€§èƒ½ï¼Œè½»é‡çº§ï¼ŒåŸç”Ÿé›†æˆ | ä»…æ”¯æŒ Chrome/Chromium |
| Selenium     | å¤šè¯­è¨€ | è·¨æµè§ˆå™¨æ”¯æŒï¼Œç”Ÿæ€ä¸°å¯Œ   | é€Ÿåº¦æ…¢ï¼Œä¾èµ– WebDriver |
| Puppeteer    | JS     | åŠŸèƒ½å¼ºå¤§ï¼Œæ´»è·ƒç¤¾åŒº       | Node.js ç¯å¢ƒä¾èµ–       |
| Playwright   | å¤šè¯­è¨€ | è·¨æµè§ˆå™¨ï¼Œç°ä»£åŒ– API     | ç›¸å¯¹è¾ƒæ–°               |


chromedp ä¸º Go å¼€å‘è€…æä¾›äº†å¼ºå¤§è€Œä¼˜é›…çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡æœ¬æŒ‡å—ï¼Œä½ å·²ç»æŒæ¡äº†ä»åŸºç¡€æ“ä½œåˆ°é«˜çº§æŠ€å·§çš„å…¨å¥—æŠ€èƒ½ã€‚æ— è®ºæ˜¯æ•°æ®æŠ“å–ã€è‡ªåŠ¨åŒ–æµ‹è¯•è¿˜æ˜¯ç½‘é¡µç›‘æ§ï¼Œchromedp éƒ½èƒ½æˆä¸ºä½ çš„å¾—åŠ›åŠ©æ‰‹ã€‚

---

<div align="center">
  <img src="../img/qrcode_wechat.jpg" alt="å­Ÿæ–¯ç‰¹">
</div>

> å£°æ˜ï¼šæœ¬ä½œå“é‡‡ç”¨[ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™… (CC BY-NC-SA 4.0)](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)è¿›è¡Œè®¸å¯ï¼Œä½¿ç”¨æ—¶è¯·æ³¨æ˜å‡ºå¤„ã€‚  
> Author: [mengbin](mengbin1992@outlook.com)  
> blog: [mengbin](https://mengbin.top)  
> Github: [mengbin92](https://mengbin92.github.io/)  
> è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒºï¼š[å­Ÿæ–¯ç‰¹](https://cloud.tencent.com/developer/user/6649301)  
---